<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topics Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Hover effect for rows */
        .clickable-row {
            cursor: pointer;
        }

        .clickable-row:hover {
            background-color: #f8f9fa;
        }


        .breadcrumb-item+.breadcrumb-item::before {
            content: "/";
            color: #6c757d;
        }

        .breadcrumb {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: .375rem;
            border: 1px solid gray;
        }

        .highlight {
            color: rgb(69, 170, 247);
            cursor: pointer;
            text-decoration: underline;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container mt-5">

        <!-- Breadcrumb Navigation -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item highlight" id="bc-home">Home</li>
                <li class="breadcrumb-item">Edit Content</li>
            </ol>
        </nav>
        <h1 class="mb-4">Topics Management</h1>

        <!-- Topics Table -->
        <table class="table table-striped table-bordered align-middle text-center">
            <thead>
                <tr class="table-dark">
                    <th>S.No</th>
                    <th>Topic</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="topicsTableBody">
                <!-- Dynamic content will be added here -->
            </tbody>
        </table>
    </div>

    <!-- Modal for Editing Topic -->
    <div class="modal fade" id="editTopicModal" tabindex="-1" aria-labelledby="editTopicModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTopicModalLabel">Edit Topic</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="topicName" class="form-label">Topic Name</label>
                    <input type="text" class="form-control" id="topicName" placeholder="Enter new topic name">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveChangesBtn">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <script>


        const uid = '{{ user_id }}';
        var bc_home = document.getElementById('bc-home');


        bc_home.addEventListener('click', () => {
            window.location.href = '/admins/' + uid
        })

    </script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global Variables
        const userId = '{{ user_id }}'; // Simulating a logged-in user
        const apiBaseUrl = "http://localhost:4000";

        // Load Topics on Page Load
        document.addEventListener("DOMContentLoaded", () => {
            loadTopics();
        });

        // Function to Load Topics
        async function loadTopics() {
            try {
                const response = await fetch(`${apiBaseUrl}/topic`);
                const topics = await response.json();
                populateTopicsTable(topics);
            } catch (error) {
                console.error("Error fetching topics:", error);
            }
        }

        // Function to Populate Topics Table
        function populateTopicsTable(topics) {
            const tableBody = document.getElementById("topicsTableBody");
            tableBody.innerHTML = ""; // Clear previous content

            topics.forEach((topic, index) => {
                const row = document.createElement("tr");
                row.className = "clickable-row";
                row.setAttribute("data-bs-toggle", "tooltip");
                row.setAttribute("data-bs-placement", "top");
                row.setAttribute("title", "Click to view subtopics");

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${topic.name}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editTopic(event, '${topic.topic_id}')">Edit</button>
                        <button class="btn btn-danger btn-sm ms-2" onclick="deleteTopic(event, '${topic.topic_id}')">Delete</button>
                    </td>
                `;

                // Redirect to subtopics on row click
                row.addEventListener("click", (event) => {
                    if (!event.target.closest("button")) {
                        window.location.href = `content/${topic.topic_id}/subtopics`;
                    }
                });

                tableBody.appendChild(row);
            });

            // Enable Bootstrap tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // Function to Edit Topic
        async function editTopic(event, topicId) {
            event.stopPropagation(); // Prevent row click

            // Fetch the current topic details
            const topic = await fetchTopicDetails(topicId);

            // Show the modal and pre-fill the current topic name
            const topicNameInput = document.getElementById("topicName");
            topicNameInput.value = topic.name;

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById("editTopicModal"));
            modal.show();

            // Handle Save Changes button click
            const saveChangesBtn = document.getElementById("saveChangesBtn");
            saveChangesBtn.onclick = async () => {
                const newName = topicNameInput.value.trim();

                if (newName) {
                    try {
                        const response = await fetch(`${apiBaseUrl}/topic/${topicId}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ name: newName }),
                        });

                        const data = await response.json();
                        if (response.ok) {
                            alert("Topic updated successfully");
                            modal.hide(); // Hide the modal after saving
                            loadTopics(); // Reload topics after edit
                        } else {
                            alert(data.error || "Failed to update topic");
                        }
                    } catch (error) {
                        console.error("Error updating topic:", error);
                        alert("Failed to update topic");
                    }
                } else {
                    alert("Topic name cannot be empty");
                }
            };
        }

        // Function to fetch topic details by ID (to get current name)
        async function fetchTopicDetails(topicId) {
            try {
                const response = await fetch(`${apiBaseUrl}/topic/${topicId}`);
                const topic = await response.json();
                return topic;
            } catch (error) {
                console.error("Error fetching topic details:", error);
                return { name: "" }; // Return empty name if there is an error
            }
        }

        // Function to Delete Topic
        async function deleteTopic(event, topicId) {
            event.stopPropagation(); // Prevent row click

            // Confirm the deletion
            const isConfirmed = confirm("Are you sure you want to delete this topic?");
            if (isConfirmed) {
                try {
                    const response = await fetch(`${apiBaseUrl}/topic/${topicId}`, {
                        method: 'DELETE',
                    });

                    if (response.ok) {
                        alert("Topic deleted successfully");
                        loadTopics(); // Reload topics after deletion
                    } else {
                        alert("Failed to delete topic");
                    }
                } catch (error) {
                    console.error("Error deleting topic:", error);
                    alert("Failed to delete topic");
                }
            }
        }
    </script>
</body>

</html>